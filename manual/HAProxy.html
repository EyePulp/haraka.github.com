<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Haraka Manual &raquo; HAProxy PROXY protocol extension support</title>
    
    <!-- Bootstrap core CSS -->
    <link href="/css/bootstrap.css" rel="stylesheet">

    <!-- Documentation extras -->
    <link href="/css/docs.css" rel="stylesheet">
    <link href="/css/pygments-manni.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
      <script src="/js/respond.min.js"></script>
    <![endif]-->

    </head>
      <body class="bs-docs-home">
        <a class="sr-only" href="#content">Skip navigation</a>

        <!-- Docs master nav -->
        <header class="navbar navbar-inverse navbar-fixed-top bs-docs-nav" role="banner">
          <div class="container">
            <div class="navbar-header">
              <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a href="/" class="navbar-brand">Haraka</a>
            </div>
            <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
              <ul class="nav navbar-nav">
                <li>
                  <a href="/about.html">About</a>
                </li>
                <li>
                  <a href="/community.html">Community</a>
                </li>
                <li>
                  <a href="/users.html">Known Users</a>
                </li>
                <li>
                  <a href="https://github.com/baudehlo/Haraka">Source on Github</a>
                </li>
                <li class="active">
                  <a href="/manual.html">Manual</a>
                </li>
              </ul>
            </nav>
          </div>
        </header>
        
        <!-- Docs page layout -->
        <div class="bs-header" id="content">
          <div class="container">
            <h1>HAProxy PROXY protocol extension support</h1>
          </div>
        </div>
        
        <div class="container bs-docs-container">
          <div class="row">
            <div class="col-md-3">
              <div class="bs-sidebar hidden-print" role="complementary">
                <ul class="nav bs-sidenav"><li><a class="submenu" data-toggle="collapse" data-target="#core">Core</a>
<ul id='core' class='nav'>
<li><a href='/README.html' target="content">Haraka</a></li>
<li><a href='/manual/Address.html' target="content">Address Object</a></li>
<li><a href='/manual/Body.html' target="content">Body Object</a></li>
<li><a href='/manual/Config.html' target="content">Config Files</a></li>
<li><a href='/manual/Connection.html' target="content">Connection Object</a></li>
<li><a href='/manual/CoreConfig.html' target="content">Core Configuration Files</a></li>
<li><a href='/manual/CustomReturnCodes.html' target="content">Custom Return Codes</a></li>
<li class="active"><a href='/manual/HAProxy.html' target="content">HAProxy PROXY protocol extension support</a></li>
<li><a href='/manual/Header.html' target="content">Header Object</a></li>
<li><a href='/manual/Net_Utils.html' target="content">Net_Utils</a></li>
<li><a href='/manual/Outbound.html' target="content">Outbound Mail with Haraka</a></li>
<li><a href='/manual/Plugins.html' target="content">Writing Haraka Plugins</a></li>
<li><a href='/manual/Transaction.html' target="content">Transaction Object</a></li>
</ul></li>
<li><a class="submenu" data-toggle="collapse" data-target="#tutorials">Tutorials</a>
<ul id='tutorials' class='nav'>
<li><a href='/manual/Tutorial.html' target="content">Writing Haraka Plugins</a></li>
<li><a href='/manual/tutorials/Migrating_from_v1_to_v2.html' target="content">Migrating from Haraka v1.x to v2.x</a></li>
<li><a href='/manual/tutorials/SettingUpOutbound.html' target="content">Configuring Haraka For Outbound Email</a></li>
</ul></li>
<li><a class="submenu" data-toggle="collapse" data-target="#plugins">Plugins</a>
<ul id='plugins' class='nav'>
<li><a href='/manual/plugins/xclient.html' target="content">XCLIENT</a></li>
<li><a href='/manual/plugins/toobusy.html' target="content">toobusy</a></li>
<li><a href='/manual/plugins/tls.html' target="content">tls</a></li>
<li><a href='/manual/plugins/tarpit.html' target="content">tarpit</a></li>
<li><a href='/manual/plugins/spf.html' target="content">spf</a></li>
<li><a href='/manual/plugins/spamassassin.html' target="content">spamassassin</a></li>
<li><a href='/manual/plugins/reseed_rng.html' target="content">reseed_rng</a></li>
<li><a href='/manual/plugins/relay_force_routing.html' target="content">relay</a></li>
<li><a href='/manual/plugins/relay_all.html' target="content">relay_all</a></li>
<li><a href='/manual/plugins/relay_acl.html' target="content">relay_acl</a></li>
<li><a href='/manual/plugins/rdns.regexp.html' target="content">rdns.regexp</a></li>
<li><a href='/manual/plugins/rcpt_to.max_count.html' target="content">rcpt</a></li>
<li><a href='/manual/plugins/rcpt_to.in_host_list.html' target="content">rcpt</a></li>
<li><a href='/manual/plugins/rcpt_to.blocklist.html' target="content">rcpt_to.blocklist</a></li>
<li><a href='/manual/plugins/rcpt_to.access.html' target="content">rcpt_to.access</a></li>
<li><a href='/manual/plugins/rate_limit.html' target="content">rate_limit</a></li>
<li><a href='/manual/plugins/queue/smtp_proxy.html' target="content">queue/smtp_proxy</a></li>
<li><a href='/manual/plugins/queue/smtp_forward.html' target="content">queue/smtp_forward</a></li>
<li><a href='/manual/plugins/queue/quarantine.html' target="content">quarantine</a></li>
<li><a href='/manual/plugins/queue/qmail-queue.html' target="content">queue/qmail-queue</a></li>
<li><a href='/manual/plugins/queue/discard.html' target="content">discard</a></li>
<li><a href='/manual/plugins/queue/deliver.html' target="content">queue/deliver</a></li>
<li><a href='/manual/plugins/process_title.html' target="content">process_title</a></li>
<li><a href='/manual/plugins/messagesniffer.html' target="content">messagesniffer</a></li>
<li><a href='/manual/plugins/max_unrecognized_commands.html' target="content">max</a></li>
<li><a href='/manual/plugins/mail_from.nobounces.html' target="content">mail_from.nobounces</a></li>
<li><a href='/manual/plugins/mail_from.is_resolvable.html' target="content">mail</a></li>
<li><a href='/manual/plugins/mail_from.blocklist.html' target="content">mail_from.blocklist</a></li>
<li><a href='/manual/plugins/mail_from.access.html' target="content">mail_from.access</a></li>
<li><a href='/manual/plugins/lookup_rdns.strict.html' target="content">lookup_rdns.strict</a></li>
<li><a href='/manual/plugins/log.syslog.html' target="content">log.syslog</a></li>
<li><a href='/manual/plugins/helo.checks.html' target="content">helo.checks</a></li>
<li><a href='/manual/plugins/graph.html' target="content">graph</a></li>
<li><a href='/manual/plugins/early_talker.html' target="content">early_talker</a></li>
<li><a href='/manual/plugins/dnswl.html' target="content">dnswl</a></li>
<li><a href='/manual/plugins/dnsbl.html' target="content">dnsbl</a></li>
<li><a href='/manual/plugins/dkim_sign.html' target="content">dkim_sign</a></li>
<li><a href='/manual/plugins/data.uribl.html' target="content">data.uribl</a></li>
<li><a href='/manual/plugins/data.signatures.html' target="content">data.signatures</a></li>
<li><a href='/manual/plugins/data.rfc5322_header_checks.html' target="content">data.rfc5322</a></li>
<li><a href='/manual/plugins/data.noreceived.html' target="content">data.noreceived</a></li>
<li><a href='/manual/plugins/data.nomsgid.html' target="content">data.nomsgid</a></li>
<li><a href='/manual/plugins/daemonize.html' target="content">daemonize</a></li>
<li><a href='/manual/plugins/connect.rdns_access.html' target="content">connect.rdns_access</a></li>
<li><a href='/manual/plugins/clamd.html' target="content">clamd</a></li>
<li><a href='/manual/plugins/block_me.html' target="content">block_me</a></li>
<li><a href='/manual/plugins/avg.html' target="content">avg</a></li>
<li><a href='/manual/plugins/auth/flat_file.html' target="content">auth/flat_file</a></li>
<li><a href='/manual/plugins/auth/auth_proxy.html' target="content">auth/auth_proxy</a></li>
<li><a href='/manual/plugins/auth/auth_ldap.html' target="content">auth/auth_ldap</a></li>
<li><a href='/manual/plugins/attachment.html' target="content">attachment</a></li>
<li><a href='/manual/plugins/aliases.html' target="content">aliases</a></li>
</ul></li></ul>

              </div>
            </div>
            
            <div class="col-md-9" role="main">
              <div class="bs-docs-section">
                <h1>HAProxy PROXY protocol extension support</h1>

<p>Haraka natively supports the PROXY protocol [1].</p>

<p>This allows an upstream proxy to pass IP address and port of the client which
Haraka will use instead of the socket IP address (which is of the proxy).
This allows DNSBLs and access control lists to operate on the proxied address.</p>

<p>Support is disabled by default and if HAProxy or other attempts to send a
PROXY command then Haraka will return a DENYSOFTDISCONNECT error.
DENYSOFT is used to prevent configuration errors from rejecting valid mail.</p>

<p>To enable support for PROXY you must create a <code>haproxy_hosts</code> configuration
file which should contain a list of IP addresses of the HAProxy hosts that 
should be allowed to send the PROXY command.  </p>

<p>When a host connects to Haraka that matches an IP address present in the
<code>haproxy_hosts</code> file - a banner is not sent, instead Haraka waits for the
PROXY command to be sent before proceeding.  The connection will timeout
with <code>421 PROXY timed out</code> if the command is not sent within 30 seconds.</p>

<p>NOTE: because Haraka does not send a banner when a listed HAProxy host 
connects you cannot use the HAProxy <code>option smtpchk</code> to test the host, 
you must just use the basic TCP check that HAProxy uses by default.</p>

<p>[1] http://haproxy.1wt.eu/download/1.5/doc/proxy-protocol.txt</p>

<p>HAProxy supports the PROXY protocol in version 1.5 or later however there
are patches available to add support for 1.4.</p>

<p>Here is an example listener section for haproxy.cfg:</p>

<p><code>
listen smtp :25
        mode tcp
        option tcplog
        balance roundrobin
        server smtp1 ip.of.haraka.server1:25 check inter 10s send-proxy
        server smtp2 ip.of.haraka.server2:25 check inter 10s send-proxy
        server smtp3 ip.of.haraka.server3:25 check inter 10s send-proxy
        server smtp4 ip.of.haraka.server4:25 check inter 10s send-proxy
        server smtp5 ip.of.haraka.server5:25 check inter 10s send-proxy
</code></p>

<p>The important part is <code>send-proxy</code> which causes HAProxy to send the PROXY
extension on connection.</p>

              </div>
            </div>
          </div>
        </div>

        <footer class="container" role="contentinfo">
            <ul class="bs-masthead-links">
            <li>
            <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
            <input type="hidden" name="cmd" value="_s-xclick">
            <input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----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-----END PKCS7-----
            ">
            <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
            <img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
            </form>
            </li>
            </ul>
        </footer>
        
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="/js/jquery.js"></script>
        <script src="/js/bootstrap.js"></script>
        <script src="/js/holder.js"></script>
        <!-- <script src="/js/application.js"></script> -->
        <script>
        $('.bs-sidebar ul ul').each(function (i, el) {
            if ($(el).find('li.active').length) {
                console.log("Doing nothing");
            }
            else {
                console.log("Collapsing");
                $(el).collapse('toggle');
            }
        })
        </script>

    </body>
</html>
