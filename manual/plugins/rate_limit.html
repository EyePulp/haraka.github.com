<!DOCTYPE html>

<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Haraka Manual &raquo; rate_limit</title>
        <link rel="stylesheet" type="text/css" href="/reset.css">
        <link rel="stylesheet" type="text/css" href="/chapter.css">
        <link rel="stylesheet" type="text/css" href="/sh_emacs.css">
        <script type="text/javascript" src="/sh_main.min.js"></script>
        <script type="text/javascript" src="/sh_javascript.min.js"></script>
        <script type="text/javascript">
        window.onload = function () {
            var pres = document.getElementsByTagName("pre"),
                text;

            for (var i = 0; i < pres.length; ++i) {
                text = pres[i].innerText || "";

                if (!(/^\s*\$/).test(text)) {
                    pres[i].className = "sh_javascript";
                }
            }

            sh_highlightDocument();
        }
        </script>
    </head>
    <body>
        <div id="content">
            <h1>rate_limit</h1>

<p>This pluign enforces limits on connection concurrency, connection rate and 
recipient rate.</p>

<p>By default DENYSOFT will be returned when the limits are exceeded, but for 
concurrency, connection rate and recipient rate by host you can optionally 
tarpit the connection by adding a delay before every response sent back to the 
client instead of sending a DENYSOFT.  To do this requires the 'tarpit' plugin 
to run immediately after this plugin.</p>

<p>To use this plugin you will need a Redis server and will need the redis, 
hiredis and ipaddr.js packages installed via:</p>

<pre><code>cd /path/to/haraka/home
npm install redis hiredis ipaddr.js
</code></pre>

<h2>Configuration</h2>

This plugin uses the configuration file rate_limit.ini which is checked for 
updates before each hook, so changes to this file will never require a restart 
and will take effect immediately after the changes are saved.

The configuration options for each heading are detailed below:

<h3>[main]</h3>

<ul>
<li><p>redis_server = \<ip | host\>[:port] <em>(optional)</em></p>

<p>If port is missing then it defaults to 6379. <br />
If this setting is missing entirely then it defaults to 127.0.0.1:6379.</p>

<p>Note that Redis does not currently support IPv6.</p></li>
<li><p>tarpit_delay = seconds <em>(optional)</em></p>

<p>Set this to the length in seconds that you want to delay every SMTP 
response to a remote client that has exceeded the rate limits.  For this 
to work the 'tarpit' plugin must be loaded <strong>after</strong> this plugin in 
config/plugins. </p>

<p>If 'tarpit' is not loaded or is loaded before this plugin, then no
rate throttling will occur.</p></li>
</ul>
<hr />


All of the following sections are optional.  Any missing section disables 
that particular test.

They all use a common configuration format:

<ul>
<li><p>\<lookup\> = \<limit\>[/time[unit]]  <em>(optional)</em></p>

<p>'lookup' is based upon the limit being enforced and is either an IP 
address, rDNS name, sender address or recipient address either in full 
or part. <br />
The lookup order is as follows and the first match in this order is 
returned and is used as the record key in Redis (except for 'default' 
which always uses the full lookup for that test as the record key):</p>

<p><strong>IPv4/IPv6 address or rDNS hostname:</strong></p>

<pre>
fe80:0:0:0:202:b3ff:fe1e:8329
fe80:0:0:0:202:b3ff:fe1e
fe80:0:0:0:202:b3ff
fe80:0:0:0:202
fe80:0:0:0
fe80:0:0
fe80:0
fe80
1.2.3.4
1.2.3
1.2
1
host.part.domain.com
part.domain.com
domain.com
com
default
</pre>

<p><strong>Sender or Recipient address:</strong></p>

<pre>
user@host.sub.part.domain.com
host.sub.part.domain.com
sub.part.domain.com
part.domain.com
domain.com
com
default
</pre>

<p>In all tests 'default' is used to specify a default limit if nothing else has 
matched.</p>

<p>'limit' specifies the limit for this lookup.  Specify 0 (zero) to disable 
limits on a matching lookup.</p>

<p>'time' is optional and if missing defaults to 60 seconds.  You can optionally 
specify the following time units (case-insensitive):</p>

<ul>
<li>s (seconds)</li>
<li>m (minutes)</li>
<li>h (hours)</li>
<li>d (days)</li>
</ul></li>
</ul>

<h3>[concurrency]</h3>

<p><strong>IMPORTANT NOTE:</strong> connection concurrency is recorded in-memory (in 
connection.server.notes) and not in Redis, so the limits are per-server and 
per-child if you use the cluster module.</p>

<p>IP and rDNS names are looked up by this test.  This section does <em>not</em> accept an 
interval.  It's a hard limit on the number of connections and not based on time.</p>

<h3>[rate_conn]</h3>

<p>This section limits the number of connections per interval from a given host 
or set of hosts.</p>

<p>IP and rDNS names are looked up by this test.</p>

<h3>[rate<em>rcpt</em>host]</h3>

<p>This section limits the number of recipients per interval from a given host or 
set of hosts. </p>

<p>IP and rDNS names are looked up by this test.</p>

<h3>[rate<em>rcpt</em>sender]</h3>

<p>This section limits the number of recipients per interval from a sender or 
sender domain.</p>

<p>The sender is looked up by this test.</p>

<h3>[rate_rcpt]</h3>

<p>This section limits the rate which a recipient or recipient domain can 
receive messages over an interval.</p>

<p>Each recipient is looked up by this test.</p>

<h3>[rate<em>rcpt</em>null]</h3>

<p>This section limits the rate at which a recipient can receive messages from 
a null sender (e.g. DSN, MDN etc.) over an interval.</p>

<p>Each recipient is looked up by this test.</p>

        </div>
    </body>
</html>
